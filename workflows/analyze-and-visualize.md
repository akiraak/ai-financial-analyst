# データ分析・可視化（GitHub Pagesレポート）

## 目的

- 業績データを投資判断の共有用ダッシュボードとしてGitHub Pagesに公開する
- 複数のデータソース（financials.json, stock-prices.json, segments.json, balance-sheet.json, cash-flows.json, segment-profit.json）を統合する
- 複数企業に対応可能な構造にする

## 予想（Outlook）データの扱い

- **企業ランディングページ**: 予想四半期は表示しない。実績四半期のリンクのみ表示する
- **グラフ**: 予想四半期（`isOutlook: true`）はグラフに含めない。グラフは実績データのみで描画する
- **財務データ表**: 予想四半期は表示する。ヘッダーに「Q4予想」と明示し、セルはグレーアウト表示
- **xlsxファイル**: 予想四半期を含む（Excelでの分析用）

## 可視化するグラフ（14チャート）

### A. 収益全体像

#### 1. P/L推移（棒グラフ）
- 売上高・粗利・営業利益・純利益の四半期推移

#### 2. 利益率推移（折れ線グラフ）
- 粗利率（grossProfit / revenue）
- 営業利益率（operatingIncome / revenue）
- 純利益率（netIncome / revenue）

#### 3. 成長率推移（折れ線グラフ）
- 売上高・営業利益・純利益のYoY成長率
- 0%ラインを基準に成長の加速・減速を把握

#### 4a. 費用（積み上げ棒グラフ）
- 売上原価（costOfRevenue）
- 研究開発費（researchAndDevelopment）
- その他販管費（sga）
- 絶対額（$M）で表示

#### 4b. 費用売上対比（積み上げ棒グラフ）
- 売上原価・研究開発費・その他販管費
- 売上高に対する構成比（%）で表示

### B. 財務基盤

#### 5. B/S概要（棒グラフ + 折れ線）
- 総資産・総負債・純資産（棒グラフ）
- 現金同等物（折れ線）

#### 6. キャッシュフロー（棒グラフ + 折れ線）
- 営業CF・投資CF・財務CF（棒グラフ）
- フリーキャッシュフロー（折れ線）

### C. 株式市場評価

#### 7. 株価 & PER（複合チャート）
- 株価: 棒グラフ（左軸）
- PER: 折れ線グラフ（右軸）
- PER = 株価 / 直近4Q EPS合計

#### 8. バリュエーション指標（複合折れ線）
- PER（左軸）、PSR・PBR（右軸）

### D. セグメント分析

セグメント分析セクションの冒頭に、2種類のセグメント区分の説明テキストを配置する。

- **市場向け5セグメント**（プレスリリースベース・売上のみ）: Data Center / Gaming / Professional Visualization / Automotive / OEM & Other
- **SEC報告2セグメント**（10-Q/10-Kベース・売上+営業利益）: Compute & Networking / Graphics
- 両者の対応関係（C&N ≒ Data Center + Automotive + Networking、Graphics ≒ Gaming + ProViz + Infotainment）

#### 9. セグメント別売上（積み上げ棒グラフ）
- 市場向け5セグメントの売上推移
- データソース: press-release.html → segments.json

#### 10. セグメント別 売上比率（100%積み上げ棒グラフ）
- 総売上に占める各セグメントの構成比率

#### 11. セグメント営業利益（棒グラフ）
- SEC報告2セグメント（Compute & Networking / Graphics）の営業利益
- データソース: 10-Q/10-K PDF → segment-profit.json

#### 12. セグメント営業利益率（折れ線グラフ）
- 各報告セグメントの営業利益率（Operating Income / Revenue）

### E. 投資ポートフォリオ

#### 13. 投資残高推移（棒グラフ + 折れ線）
- 非上場株式（Non-marketable Equity Securities）: 棒グラフ
- 上場株式（Publicly-held Equity Securities）: 折れ線
- 投資コミットメント情報は静的テキストで記載（Intel, OpenAI, Anthropic等）
- データソース: 10-Q/10-K PDF → investments.json

## 企業比較ダッシュボード（docs/compare/index.html）

全10社の主要指標を横並びで比較する静的HTMLページ。各社の `data.json` をブラウザ側で並列fetchし、Chart.jsで6チャート+サマリーテーブルを描画する。

### 比較チャート（6種）

| # | 指標 | 形式 | 対象企業 | 備考 |
|---|------|------|---------|------|
| 1 | 時価総額 | 横棒グラフ | 全10社 | price × sharesDiluted。TSMCはADR価格÷5 |
| 2 | 売上高 | 横棒グラフ | 9社（TSMC除外） | NT$建てのため除外 |
| 3 | 営業利益 | 横棒グラフ | 9社（TSMC除外） | NT$建てのため除外 |
| 4 | 営業利益率 | 横棒グラフ | 全10社 | 比率は通貨非依存 |
| 5 | 売上成長率 YoY | 横棒グラフ | 全10社 | 前年同期比、通貨非依存 |
| 6 | PER（TTM） | 横棒グラフ | EPS正の企業のみ | TSMCはepsADR使用 |

各チャートは値の大きい順にソートして表示する。

### 単位正規化（docs/js/compare.js の NORMALIZE テーブル）

各社の data.json の単位が異なるため、compare.js 内で百万USD・百万株に統一する:

| 企業 | 売上単位 | 株数単位 | revMul | sharesMul | 備考 |
|------|---------|---------|--------|-----------|------|
| NVIDIA, Broadcom, Alphabet, Intel, Meta, Tesla, Microsoft | 百万USD | 百万株 | 1 | 1 | |
| Palantir | 千USD | 千株 | 0.001 | 0.001 | |
| Apple | 百万USD | 千株 | 1 | 0.001 | 株数のみ変換 |
| TSMC | 百万NT$ | 百万株 | — | 1 | isUSD: false。時価総額=ADR価格×株数÷5 |

**新規企業追加時:** NORMALIZE テーブルにエントリを追加し、isUSD フラグと乗数を正しく設定すること。

### ファイル構成

| ファイル | 役割 |
|---------|------|
| `docs/compare/index.html` | 比較ページHTML（静的、ビルドスクリプト不要） |
| `docs/js/compare.js` | CompareChartオブジェクト（データ読み込み・正規化・6チャート・サマリーテーブル） |

### 更新タイミング

- **各社の決算更新後:** 各社の data.json が更新されれば、比較ページはブラウザ側で最新データを自動的に読み込む。**追加のビルド作業は不要**
- **新規企業追加時:** compare.js の `COMPANIES`, `DISPLAY_NAMES`, `TICKERS`, `NORMALIZE`, `COLORS` にエントリを追加する
- **チャート種類の追加・変更時:** compare.js にチャート生成メソッドを追加し、compare/index.html にcanvas要素と初期化コードを追加する

## データソース

### 抽出済みデータ
| ファイル | 内容 | ソース |
|---------|------|-------|
| `financials.json` | P/L項目（四半期単位） | press-release.html |
| `stock-prices.json` | 四半期末株価・日付 | Yahoo Finance API |
| `segments.json` | 市場向け5セグメント売上 | press-release.html |
| `balance-sheet.json` | B/S項目 | press-release.html |
| `cash-flows.json` | CF項目 | press-release.html |
| `segment-profit.json` | SEC報告2セグメントの売上+営業利益 | 10-Q/10-K PDF |
| `investments.json` | 非上場・上場株式残高・投資活動 | 10-Q/10-K PDF |

### 導出指標（レポート側で計算）
- 粗利率、営業利益率、純利益率
- PER（直近4Q EPS合計ベース）、PSR、PBR
- 費用構成比（各費用 / 売上高）
- YoY成長率
- セグメント営業利益率

## OGP（Open Graph）メタタグ

外部サイト（SNS・Slack等）からリンクされた際にタイトル・説明・画像が表示されるよう、全ページにOGPメタタグを設定する。

**設定するタグ:**
- `og:title` — ページタイトル
- `og:description` — ページ説明文
- `og:type` — `website`
- `og:url` — ページの正規URL
- `og:image` — OGP画像（全ページ共通で `docs/ogp.png` を使用、1200×630px推奨）
- `og:site_name` — `AI Financial Analyst`
- `twitter:card` — `summary_large_image`

**ページ別のOGP内容:**
| ページ | og:title | og:description |
|--------|----------|----------------|
| トップページ | AI Financial Analyst | 業績データの分析・可視化ダッシュボード |
| 企業ランディング | {企業名} ({ティッカー}) 業績レポート | generate-pages.jsのDESC定数 |
| 四半期選択 | {企業名} 四半期分析一覧 | {企業名}の四半期ごとの業績分析・チャートを閲覧 |
| 四半期詳細 | {企業名} {四半期ラベル} 決算分析 | {企業名} {四半期ラベル}の業績分析・チャート |

**四半期詳細ページのプレースホルダ置換:**
- template.html では `{{QUARTER_LABEL}}` と `{{QUARTER_DIR}}` をプレースホルダとして埋め込む
- generate-data-json.js がtemplate.htmlを各四半期フォルダにコピーする際、これらを実際の値（例: `FY2026 Q2`, `2026Q2`）に置換する

**OGP画像の配置:**
- 全ページ共通: `docs/ogp.png`（1200×630px推奨）
- 画像が未配置でもタイトル・説明文は表示される

## 技術スタック

- **GitHub Pages** — 静的HTMLホスティング
- **Chart.js** — チャートライブラリ（CDN読み込み、ビルド不要）
- **データ形式** — JSONを直接fetch

## ディレクトリ構成

```
docs/                              # GitHub Pages公開ディレクトリ
├── index.html                     # 企業一覧ページ
├── js/
│   ├── chart-builder.js           # 共通チャート生成ロジック（14チャート）
│   ├── quarter-detail.js          # 四半期詳細ページのロジック
│   └── compare.js                 # 企業比較チャート生成ロジック（6チャート）
├── css/
│   └── style.css                  # 共通スタイル
├── compare/
│   └── index.html                 # 企業比較ダッシュボード
└── <企業名>/
    ├── index.html                 # ランディングページ（四半期リンクのみ）
    ├── data.json                  # 統合JSON（全データソースを結合）
    ├── analysis-text.json         # チャート解説・決算サマリー（四半期詳細ページの表示に必須）
    └── quarters/                  # 四半期別分析ページ
        ├── index.html             # 四半期選択ページ
        ├── template.html          # 詳細ページテンプレート
        └── <YYYYQN>/             # 例: 2026Q3/
            ├── index.html         # 四半期詳細ページ
            └── data.json          # その四半期までのデータ
```

### data.json の生成
- 全JSONデータソースを統合して docs/<企業名>/data.json として出力する
- 生成スクリプト: `companies/<企業名>/scripts/generate-data-json.js`
- トップレベルに `nextEarningsDate` を含む（config.json から取得。トップページのカード表示に使用）

## ページ構成

### 企業ランディングページ（`<企業名>/index.html`）

```
┌──────────────────────────────────┐
│ ヘッダー（企業名・ティッカー・    │
│ 対象期間・四半期数・更新日）      │
├──────────────────────────────────┤
│ 四半期分析リンク                  │
│  FY別にQ1〜Q4のリンクを表示      │
│  実績のみ（予想は表示しない）     │
├──────────────────────────────────┤
│ 財務データ                       │
│  xlsxダウンロードリンク           │
│  財務データ表（全四半期横並び）   │
├──────────────────────────────────┤
│ フッター（データソース情報）       │
└──────────────────────────────────┘
```

**財務データ表の仕様:**
- data.json を読み込んで動的生成する（JSロジック）
- 2行ヘッダー: 1行目=年度（colspan）、2行目=四半期ラベル（Outlookは「Q4予想」）
- 四半期ヘッダーから各四半期詳細ページへリンクする
- 24行の財務項目:
  - 売上高（前期比・前年比）、粗利益（粗利率・前年比）
  - R&D（売上比）、その他販管費（売上比）、販管費合計（売上比・前年比）
  - 営業利益（営業利益率・前年比）、営業外収支
  - 純利益（純利益率・前年比）
  - EPS、PER、PER 4Q平均、株価
- カテゴリ別背景色: 売上=緑、利益=青、費用=橙、株式=紫
- Outlook列はグレーアウト表示

### 四半期詳細ページ（`quarters/<YYYYQN>/index.html`）

テンプレート: `quarters/template.html` — generate-data-json.js が各四半期フォルダにコピーして生成する。
テンプレートを変更したら `generate-data-json.js` を再実行して全四半期ページに反映すること。

```
┌──────────────────────────────────┐
│ ヘッダー（企業名・四半期名）      │
│ 四半期ナビ（前後移動リンク）      │
├──────────────────────────────────┤
│ セクションナビ                    │
│  KPI / 財務データ / A〜E / 決算資料│
├──────────────────────────────────┤
│ KPIサマリー（動的生成）           │
│  売上高・粗利・営業利益・純利益   │
│  ・EPS・株価（QoQ/YoY付き）      │
├──────────────────────────────────┤
│ 財務データ表（動的生成）          │
│  24行の財務項目×全四半期横並び   │
│  ※仕様はランディングページと同一  │
├──────────────────────────────────┤
│ A. 収益全体像                     │
│  1. P/L推移 + 解説               │
│  2. 利益率推移 + 解説             │
│  3. 成長率推移 + 解説             │
│  4a. 費用 + 解説                  │
│  4b. 費用売上対比 + 解説          │
├──────────────────────────────────┤
│ B. 財務基盤                      │
│  5. B/S概要 + 解説               │
│  6. キャッシュフロー + 解説        │
├──────────────────────────────────┤
│ C. 株式市場評価                   │
│  7. 株価 & PER + 解説            │
│  8. バリュエーション指標 + 解説    │
├──────────────────────────────────┤
│ D. セグメント分析                  │
│  [セグメント区分の説明テキスト]     │
│  9. セグメント別売上 + 解説       │
│  10. セグメント別 売上比率 + 解説      │
│  11. セグメント営業利益 + 解説    │
│  12. セグメント営業利益率 + 解説  │
├──────────────────────────────────┤
│ E. 投資ポートフォリオ              │
│  13. 投資残高推移 + 解説          │
│  投資コミットメント（KPI+一覧）   │
├──────────────────────────────────┤
│ 決算資料リンク（動的生成）        │
├──────────────────────────────────┤
│ フッター                          │
└──────────────────────────────────┘
```

**各チャートの「解説・分析」について:**
- 各チャートの下に `<details class="chart-details">` で折りたたみ配置する
- 「概要」と「分析」の2段構成:
  - **概要:** グラフが何を表示しているかの一般的な説明（四半期によらず共通）
  - **分析:** 最新四半期のデータに基づく具体的な数値分析（四半期固有の内容）
- template.html に静的HTMLとして定義する
- 新しい四半期データが追加された際は「手順5. 分析コメントの更新」に従って更新する

**セグメント区分の説明テキスト:**
- D. セグメント分析セクションの冒頭に配置する
- 市場向け5セグメントとSEC報告2セグメントの2種類の区分とその対応関係を説明する

**投資コミットメントセクション:**
- E. 投資ポートフォリオの投資残高推移チャートの後に配置する
- KPIグリッド（非上場株式残高・上場株式残高・投資コミットメント総額）
- 主要コミットメント一覧（企業名・金額・ステータス）
- template.html に静的HTMLとして定義する
- 新しい四半期データが追加された際は「手順5. 分析コメントの更新」に従って更新する

## 手順

### 0. データ充足チェック

四半期詳細ページは時系列チャート（累積表示）を含む。各ページにはその四半期までの利用可能なデータをすべて表示する。

**方針:**
- 四半期詳細ページはダウンロード済みデータの範囲内で生成する。追加ダウンロードは不要
- データが少ない古い四半期のチャートはデータポイントが少なくなるが、それで問題ない
- B/S・CF・セグメント損益・投資データはプレスリリースから抽出可能な範囲で取得する。データが含まれていない四半期は該当フィールドを null として扱う
- **データが全四半期でnullのチャートセクションは自動的に非表示になる**（quarter-detail.js がデータ有無を判定し、セクションを `display:none` にする）。対象: セグメント営業利益・セグメント営業利益率・投資ポートフォリオ

### 1. データ抽出スクリプトの実行
各抽出スクリプトを実行してJSONデータを生成する。

| スクリプト | 出力 |
|-----------|------|
| `extract-financials.js` | financials.json |
| `extract-segments.js` | segments.json |
| `extract-balance-sheet.js` | balance-sheet.json |
| `extract-cash-flows.js` | cash-flows.json |
| `extract-segment-profit.js` | segment-profit.json |
| `extract-investments.js` | investments.json |
| `fetch-stock-prices.js` | stock-prices.json |

### 2. ページHTMLの生成
`generate-pages.js` を実行してHTMLページを生成する。
このスクリプトは以下を生成する:
- `docs/<企業名>/index.html` — ランディングページ（四半期リンク + 財務データ表）
- `docs/<企業名>/quarters/index.html` — 四半期選択ページ（FY別カード一覧）
- `docs/<企業名>/quarters/template.html` — 四半期詳細テンプレート（KPI + 14チャート + セグメント説明）

これらのHTMLファイルはすべてこのスクリプトから生成される。git履歴からの復元や手動作成は行わない。

### 3. data.json の生成と四半期ページの生成
`generate-data-json.js` を実行して全データを統合する。
このスクリプトは以下を自動生成する:
- `docs/<企業名>/data.json` — 全四半期の統合データ
- `docs/<企業名>/quarters/<YYYYQN>/data.json` — 各四半期までの累積データ
- `docs/<企業名>/quarters/<YYYYQN>/index.html` — template.html のコピー（`{{QUARTER_LABEL}}`・`{{QUARTER_DIR}}` を実際の値に置換）

**期間制御:** `config.json` の `pageYears` と `chartYears` に基づいて生成範囲を制御する。
- `pageYears`: 新規に四半期詳細ページを生成する対象期間（最新N年分）
- `chartYears`: 各四半期ページの data.json に含めるデータ期間（チャートの表示範囲）
- config.json が無い場合はデフォルト値（pageYears: 2, chartYears: 2）を使用する
- **既存ページの保持:** `pageYears` の範囲外でも、既にフォルダが存在する四半期は `hasPage=true` を維持し、ランディングページの一覧に表示し続ける。決算更新で新四半期を追加しても、過去のページが一覧から消えない

**重要:** template.html を変更した場合も、このスクリプトを再実行して全四半期ページに反映すること。

### 4. 分析テキストの作成（analysis-text.json）

`docs/<企業名>/analysis-text.json` を作成する。このファイルは四半期詳細ページの解説テキスト・決算サマリーの表示に**必須**であり、存在しない場合ページのテキストがすべて空になる。

**ファイル構造:**
```json
{
  "overviews": {
    "<chartId>": "チャートの一般的な説明（全四半期共通）"
  },
  "quarters": {
    "<YYYYQN>": {
      "summary": [
        // --- 定性情報（上部に表示、type: "qualitative"） ---
        { "type": "qualitative", "label": "見出し", "text": "テキスト本文" },
        { "type": "qualitative", "label": "見出し", "items": ["箇条書き1", "箇条書き2"] },
        // --- 数値分析（下部に表示、typeなし） ---
        { "label": "見出し", "text": "数値ベースのサマリー本文" }
      ],
      "charts": {
        "<chartId>": "その四半期の具体的な数値分析"
      }
    }
  }
}
```

**決算サマリーの構成:**

サマリーは「定性情報」→「数値分析」の2部構成で表示される。定性情報は左ボーダー付きブロック、数値分析は従来のテキスト形式で、間に区切り線が入る。

**定性情報（`type: "qualitative"`）:**
- プレスリリースの内容を**漏れなく**記述する。重要トピックだけを選ぶのではなく、全内容をカバーする
- 1ブロックに大量の項目を詰め込まず、**カテゴリ別に複数ブロックに分割**して見やすくする
- 各ブロックは `items`（文字列配列→箇条書き表示）を使用し、3〜12項目程度に収める
- `label` はカテゴリを端的に表す見出しにする。推奨構成（企業・四半期により調整可）:
  1. **製品・プラットフォーム** — 新製品・技術発表
  2. **戦略提携・投資** — パートナーシップ・投資・ライセンス契約
  3. **セグメント別ハイライト** — 各セグメントの売上・注目点
  4. **株主還元・財務** — FCF・投資残高・配当・自社株買い
  5. **来期ガイダンス（Q? FYXXXX）** — 数値ガイダンス・方針変更
  6. **CEOコメント（CEO名）** — CEO発言の要旨・定性的展望
- 該当するトピックがないカテゴリは省略してよい。逆に必要ならカテゴリを追加してよい

**数値分析（`type` なし）:**
- 従来通り `label` + `text` のテキスト形式
- 3〜4項目で四半期の業績ハイライトを記述

**対象チャートID（12種）:**
`plChart`, `marginChart`, `costAmountChart`, `costRatioChart`, `balanceSheetChart`, `cashFlowChart`, `pricePERChart`, `valuationChart`, `segmentRevenueChart`, `segmentCompositionChart`, `segmentProfitChart`, `segmentMarginChart`, `investmentChart`

**書き方のルール:**
- 「概要（overviews）」はチャートが何を表示するかの一般的な説明。四半期によらず共通
- 「解説（quarters.*.charts）」は最新四半期のデータに基づく具体的な数値分析。金額・比率・成長率を含める
- 「決算サマリー（quarters.*.summary）」は定性情報（プレスリリースから抽出した定性的ハイライト）+ 数値分析3〜4項目で構成する
- データが取得できていないチャート（segmentProfit, investments等がnullの場合）はその旨を記載

**初回・新四半期追加時とも、このステップで全四半期分のテキストを生成・更新する。**

### 5. ページの確認
- ランディングページ: `docs/<企業名>/index.html` — 四半期リンク・財務データ表が正しく表示されること
- 四半期詳細ページ: `docs/<企業名>/quarters/<YYYYQN>/index.html` — KPI・14チャート・解説テキスト・決算サマリーが正しく表示されること

### 6. GitHub Pages の有効化
リポジトリの Settings → Pages で `docs/` ディレクトリを公開元に設定する。
