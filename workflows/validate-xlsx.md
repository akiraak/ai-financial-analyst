# 生成されたxlsxの数値検証

## 目的

`generate-xlsx.js` が生成した業績xlsxの数値が、ソースデータ（financials.json, stock-prices.json）および決算資料（press-release.html）と一致するか検証する。

## 対象ファイル

- 検証対象: `companies/<企業名>/ir-data/<企業名>業績.xlsx`
- ソース1: `companies/<企業名>/ir-data/financials.json`
- ソース2: `companies/<企業名>/ir-data/stock-prices.json`
- ソース3: `companies/<企業名>/filings/FY*/Q*/press-release.*`（原本）

## 手順

### 1. xlsx → JSON 読み取り

ExcelJSで生成済みxlsxを読み込み、全四半期のセル値をJSON形式で取得する。

行とデータの対応:

| Row | 項目 | 種別 | 検証方法 |
|-----|------|------|---------|
| 3 | 売上高 | リテラル値 | financials.json の `revenue` と完全一致 |
| 6 | 粗利 | リテラル値 | financials.json の `grossProfit` と完全一致 |
| 9 | R&D | リテラル値 | financials.json の `researchAndDevelopment` と完全一致 |
| 11 | その他販管費 | リテラル値 | financials.json の `sga` と完全一致 |
| 13 | 販管費 | 計算値 | R&D + SGA、または `totalOperatingExpenses` と一致 |
| 16 | 営業利益 | リテラル値 | financials.json の `operatingIncome` と完全一致 |
| 19 | 営業外収支 | 計算値 | `getNonOperatingIncome()` のロジックで再計算した値と一致 |
| 20 | 純利益 | リテラル値 | financials.json の `netIncome` と完全一致 |
| 23 | EPS | 計算値 | `epsDiluted` をスプリット調整（`adjustEPS`）した値と一致 |
| 26 | 株価 | リテラル値 | stock-prices.json の `price` と完全一致 |

### 2. リテラル値の検証

financials.json / stock-prices.json の値とxlsxのセル値を全四半期で突合する。

**判定基準:**
- 整数項目（売上高、利益等）: 完全一致
- EPS: 小数第2位まで一致（スプリット調整後）
- 株価: 小数第2位まで一致
- null/未設定: xlsx側も空であること

### 3. 数式セルの検証

数式が入るセルについて、ソースデータから期待値を自分で計算し、xlsxのセル値と比較する。

| Row | 項目 | 期待値の計算方法 | 許容誤差 |
|-----|------|-----------------|---------|
| 4 | 前期比 | 今期売上 / 前期売上 | ±0.001 |
| 5 | 前年比 | 前年同期売上 / 今期売上 | ±0.001 |
| 7 | 粗利売上比 | 粗利 / 売上高 | ±0.001 |
| 8 | 粗利前年比 | 今年粗利 / 前年粗利 | ±0.001 |
| 10 | R&D売上比 | R&D / 売上高 | ±0.001 |
| 12 | SGA売上比 | SGA / 売上高 | ±0.001 |
| 14 | 販管費売上比 | 販管費 / 売上高 | ±0.001 |
| 15 | 販管費前年比 | 今年販管費 / 前年販管費 | ±0.001 |
| 17 | 営業利益売上比 | 営業利益 / 売上高 | ±0.001 |
| 18 | 営業利益前年比 | 今年営業利益 / 前年営業利益 - 1 | ±0.001 |
| 21 | 純利益売上比 | 純利益 / 売上高 | ±0.001 |
| 22 | 純利益前年比 | 今年純利益 / 前年純利益 - 1 | ±0.001 |

**注意:** ExcelJSは数式のセルについて計算結果（`cell.result`）を保持しない場合がある。その場合は数式文字列（`cell.formula`）が正しいパターンかを検証する。

### 4. 予想（Outlook）データの検証

`isOutlook: true` のデータについて、決算資料のOutlookセクションとの整合性を確認する。

- 売上高: ガイダンスの数値と一致するか
- 粗利: ガイダンスの粗利率 × 売上高 と一致するか
- 販管費: ガイダンスのGAAP operating expenses と一致するか
- 営業外収支: ガイダンスの other income/expense と一致するか
- 純利益: (営業利益 + 営業外) × (1 - ガイダンス税率) と一致するか

### 5. 原本との突合（サンプリング）

全四半期を原本と突合するのは作業量が大きいため、以下をサンプリングして press-release.html の値と直接比較する。

- **最新四半期**（直近の実績）
- **最古四半期**（FY範囲の最初）
- **任意の中間四半期**（1つ以上）

確認項目: 売上高、粗利、営業利益、純利益、EPS（最低限この5項目）

### 6. 結果レポート

検証結果を以下の形式で報告する:

```
検証結果サマリー:
- 対象: <ファイル名>
- 四半期数: 実績 XX + 予想 XX = 計 XX
- リテラル値: XX項目中 XX一致 / XX不一致
- 数式セル: XX項目中 XX正常 / XX異常
- 原本突合: XX項目中 XX一致 / XX不一致
- 判定: OK / NG（不一致があれば詳細を列挙）
```

不一致があった場合は、四半期・行番号・期待値・実際の値を明記する。
